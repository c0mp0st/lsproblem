require 'packer'
require 'trollop'
require 'fileutils'

opts = Trollop::options do
  version "packer #{Packer::VERSION}"
  banner "Packer usage:\n"
  opt :uri, "Specify Git URI", :type => :string
  opt :sha, "SHA1 to check out", :type => :string
  opt :name, "Project name", :type => :string
  opt :ver, "Project version", :type => :string
  opt :dest, "Destination directory", :type => :string, :default => Dir.pwd
end

[:uri, :sha, :name, :ver].each do |param|
  Trollop::die param, "missing" unless opts[param]
end

p = Packer::Processor.new(opts[:name], opts[:ver])
begin
  tarfile = p.fetch(opts[:uri], opts[:sha]).build.mktar
  from = "#{p.tmpdir}/#{tarfile}"
  FileUtils.mv(from, opts[:dest])
  puts "Wrote #{opts[:dest]}/#{tarfile}"
ensure
  p.cleanup
end
